<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Kid Connection Puzzle</title>
    <!-- Load Tailwind CSS for modern, responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and basic centering */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef2ff; /* Light indigo background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        /* Style for the game tiles (big and colorful) */
        .tile {
            height: 90px; /* Even bigger touch targets for kids */
            font-size: 1.35rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            border: 4px solid #fff; /* White border for definition */
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); /* Soft shadow */
        }
        /* Selected tile style */
        .tile-selected {
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            transform: scale(1.03);
            border-color: #fcd34d; /* Yellow border when selected */
        }
        /* Solved group colors (using cheerful, distinct colors) */
        .group-1 { background-color: #34d399; color: #1f2937; } /* Emerald */
        .group-2 { background-color: #facc15; color: #1f2937; } /* Amber */
        .group-3 { background-color: #f87171; color: white; } /* Red */
        .group-4 { background-color: #60a5fa; color: white; } /* Blue */

        /* Animation for a wrong guess */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }
        .shake-animation {
            animation: shake 0.5s ease-in-out;
        }
    </style>
</head>
<body>

    <!-- MASTER VIEW CONTAINER -->
    <div id="master-container" class="w-full max-w-xl">

        <!-- 1. HOME SCREEN VIEW -->
        <div id="home-screen" class="bg-white p-8 rounded-3xl shadow-2xl border-b-8 border-indigo-500 text-center">
            <h1 class="text-5xl font-extrabold text-indigo-700 mb-4">Kid Connection</h1>
            <p class="text-xl text-gray-600 mb-8">Daily Puzzle Fun!</p>

            <button id="start-game-button" onclick="showView('game-screen')"
                class="w-full mb-6 px-8 py-4 bg-green-500 text-white font-extrabold text-2xl rounded-xl shadow-xl hover:bg-green-600 transition-transform transform hover:scale-105">
                START TODAY'S PUZZLE
            </button>

            <!-- How to Play Section -->
            <button id="instructions-button" onclick="toggleInstructions()"
                class="w-full mb-4 px-8 py-3 bg-yellow-500 text-white font-bold text-lg rounded-xl shadow-md hover:bg-yellow-600 transition-colors">
                How to Play ▼
            </button>

            <div id="instructions-section" class="text-left p-4 bg-gray-50 rounded-lg hidden">
                <h3 class="text-2xl font-bold text-gray-700 mb-2">The Rules are Simple!</h3>
                <ul class="list-disc list-inside space-y-2 text-base text-gray-600">
                    <li>Find **4 words** that belong to the same group or category.</li>
                    <li>Click on the 4 words, then hit the **Guess** button.</li>
                    <li>If you're right, the words disappear and the category is revealed!</li>
                    <li>You only get **4 Mistakes** (lives). Run out of mistakes and the game is over!</li>
                    <li>A new puzzle appears every day!</li>
                </ul>
            </div>
        </div>


        <!-- 2. GAME SCREEN VIEW (The actual puzzle) -->
        <div id="game-screen" class="hidden bg-white p-6 rounded-3xl shadow-2xl border-b-8 border-indigo-500">
            <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-2">Kid Connection Puzzle</h1>
            <p class="text-center text-sm text-gray-500 mb-6">Today's Puzzle: <span id="puzzle-date"></span></p>

            <!-- Lives and Message Area -->
            <div class="flex justify-between items-center mb-6 p-4 bg-indigo-50 rounded-xl shadow-inner border-l-4 border-indigo-400">
                <div class="text-xl font-semibold text-gray-700 flex items-center">
                    Mistakes: <span id="lives-display" class="text-red-500 font-bold ml-2">4</span>
                </div>
                <div id="message-display" class="text-lg font-medium text-indigo-600 transition-opacity duration-300">
                    Pick 4 words that go together!
                </div>
            </div>

            <!-- Game Grid -->
            <div id="game-grid" class="grid grid-cols-4 gap-3 mb-6">
                <!-- Tiles will be inserted here by JavaScript -->
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="submit-button" onclick="submitGuess()"
                    class="flex-1 px-8 py-4 bg-green-500 text-white font-extrabold text-lg rounded-xl shadow-xl hover:bg-green-600 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Guess
                </button>
                <button id="deselect-button" onclick="deselectAll()"
                    class="flex-1 px-8 py-4 bg-yellow-500 text-white font-extrabold text-lg rounded-xl shadow-xl hover:bg-yellow-600 transition-transform transform hover:scale-105">
                    Clear Selection
                </button>
            </div>
            
            <!-- Added back to home button for easy navigation -->
            <div class="mt-4 text-center">
                <button onclick="showView('home-screen')" class="text-indigo-500 hover:text-indigo-700 text-sm font-semibold transition-colors">
                    ← Back to Menu
                </button>
            </div>
        </div>
    </div>


    <!-- Modal for Game Over/Win (Custom UI replacement for alert()) -->
    <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full border-t-8 border-indigo-600 transform scale-0 transition-transform duration-300" id="modal-content">
            <h2 id="modal-title" class="text-3xl font-extrabold text-indigo-700 mb-4"></h2>
            <!-- Modal message area will now contain the dynamic results summary or the loss message -->
            <div id="modal-message"></div>
            <!-- The button now simply closes the modal and takes the user back to the home screen -->
            <button onclick="closeModalAndGoHome()"
                class="w-full mt-6 px-6 py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-md hover:bg-indigo-600 transition-colors">
                Done for Today! (Go to Menu)
            </button>
        </div>
    </div>

    <script>
        // --- Game Data (Mocking your continuous SQL list) ---
        const ALL_PUZZLES = [
            // Puzzle 1
            [
              { name: "Things That Fly", words: ["BIRD", "PLANE", "KITE", "BEE"], groupClass: "group-1" },
              { name: "In the Kitchen", words: ["SPOON", "FORK", "PLATE", "CUP"], groupClass: "group-2" },
              { name: "Colors of the Rainbow", words: ["RED", "BLUE", "GREEN", "YELLOW"], groupClass: "group-3" },
              { name: "School Supplies", words: ["PENCIL", "BOOK", "GLUE", "CRAYON"], groupClass: "group-4" }
            ],
            // Puzzle 2
            [
              { name: "Jungle Animals", words: ["TIGER", "MONKEY", "SNAKE", "PARROT"], groupClass: "group-1" },
              { name: "Round Foods", words: ["ORANGE", "PEA", "COIN", "PIZZA"], groupClass: "group-2" },
              { name: "Starts with 'S'", words: ["SHIP", "SOCKS", "STAR", "SUN"], groupClass: "group-3" },
              { name: "Weather Words", words: ["RAIN", "SNOW", "CLOUD", "WIND"], groupClass: "group-4" }
            ],
            // Puzzle 3
            [
              { name: "Things Made of Wood", words: ["CHAIR", "TABLE", "LOG", "PENCIL"], groupClass: "group-1" },
              { name: "Family Members", words: ["MOM", "DAD", "BROTHER", "SISTER"], groupClass: "group-2" },
              { name: "Things You Wear", words: ["HAT", "SHIRT", "PANTS", "SHOES"], groupClass: "group-3" },
              { name: "Words that Rhyme", words: ["CAT", "HAT", "MAT", "SAT"], groupClass: "group-4" }
            ]
            // You can add hundreds of more puzzles here!
        ];

        // --- Game State Variables ---
        let allWords = [];
        let selectedWords = [];
        let solvedGroups = [];
        let lives = 4;
        let isGameOver = false;
        let currentPuzzle = [];
        let startTime = 0; // New variable to track when the game starts

        // --- DOM Elements ---
        const HOME_SCREEN = document.getElementById('home-screen');
        const GAME_SCREEN = document.getElementById('game-screen');
        const INSTRUCTIONS_SECTION = document.getElementById('instructions-section');
        const INSTRUCTIONS_BUTTON = document.getElementById('instructions-button');

        const GRID = document.getElementById('game-grid');
        const LIVES_DISPLAY = document.getElementById('lives-display');
        const MESSAGE_DISPLAY = document.getElementById('message-display');
        const SUBMIT_BUTTON = document.getElementById('submit-button');
        const MODAL = document.getElementById('modal');
        const MODAL_CONTENT = document.getElementById('modal-content');
        const MODAL_TITLE = document.getElementById('modal-title');
        const MODAL_MESSAGE = document.getElementById('modal-message');
        const PUZZLE_DATE_DISPLAY = document.getElementById('puzzle-date');

        // --- NEW View Management Function ---
        function showView(viewId) {
            HOME_SCREEN.classList.add('hidden');
            GAME_SCREEN.classList.add('hidden');

            if (viewId === 'home-screen') {
                HOME_SCREEN.classList.remove('hidden');
            } else if (viewId === 'game-screen') {
                GAME_SCREEN.classList.remove('hidden');
                setupGame(); // Start the game only when the game screen is shown
            }
        }

        // --- NEW How To Play Toggle ---
        function toggleInstructions() {
            const isHidden = INSTRUCTIONS_SECTION.classList.contains('hidden');
            if (isHidden) {
                INSTRUCTIONS_SECTION.classList.remove('hidden');
                INSTRUCTIONS_BUTTON.textContent = 'Hide Instructions ▲';
            } else {
                INSTRUCTIONS_SECTION.classList.add('hidden');
                INSTRUCTIONS_BUTTON.textContent = 'How to Play ▼';
            }
        }


        // --- Utility Function: Get Daily Puzzle ---
        function getDailyPuzzle() {
            // Calculate days since a start date (e.g., Jan 1, 2024)
            const START_DATE = new Date('2024-01-01');
            const now = new Date();
            const timeDifference = now.getTime() - START_DATE.getTime();
            const dayIndex = Math.floor(timeDifference / (1000 * 3600 * 24)); // Days since start

            // Use the modulo operator (%) to cycle through the puzzles
            const puzzleIndex = dayIndex % ALL_PUZZLES.length;

            // Set the current puzzle and display the date
            currentPuzzle = ALL_PUZZLES[puzzleIndex];
            PUZZLE_DATE_DISPLAY.textContent = now.toDateString();

            // Shuffle the words for this specific daily puzzle
            let wordsToShuffle = [];
            currentPuzzle.forEach(category => {
                // FIX: Corrected typo from 'wordsToToShuffle' to 'wordsToShuffle'
                wordsToShuffle.push(...category.words);
            });
            shuffleArray(wordsToShuffle);
            allWords = wordsToShuffle;
        }

        // --- Utility Function: Shuffle Array (Fisher-Yates) ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // --- Utility Function: Format Time (seconds to M:SS) ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        }

        // --- Game Initialization (Called by showView('game-screen')) ---
        function setupGame() {
            // 1. Get today's unique puzzle
            getDailyPuzzle();

            // 2. Reset state
            selectedWords = [];
            solvedGroups = [];
            lives = 4;
            isGameOver = false;
            startTime = Date.now(); // Start the timer!

            // 3. Update UI elements
            LIVES_DISPLAY.textContent = lives;
            MESSAGE_DISPLAY.textContent = "Click 4 words that match!";
            GRID.innerHTML = '';
            SUBMIT_BUTTON.disabled = true;
            MODAL.classList.add('hidden');
            MODAL_CONTENT.classList.remove('scale-100'); // Reset modal animation

            // 4. Render the tiles
            renderGrid();
        }

        // --- Render the Tiles ---
        function renderGrid() {
            GRID.innerHTML = ''; // Clear the grid first
            allWords.forEach(word => {
                const tile = document.createElement('div');
                tile.className = 'tile flex items-center justify-center bg-gray-200 text-gray-800 rounded-xl uppercase p-2';
                tile.textContent = word;
                tile.setAttribute('data-word', word);
                tile.onclick = () => selectTile(word, tile);
                GRID.appendChild(tile);
            });
        }

        // --- Select/Deselect a Tile ---
        function selectTile(word, element) {
            if (isGameOver || solvedGroups.some(g => g.words.includes(word))) return;

            const isSelected = selectedWords.includes(word);

            if (isSelected) {
                // Deselect the word
                selectedWords = selectedWords.filter(w => w !== word);
                element.classList.remove('tile-selected');
                element.classList.remove('bg-indigo-600', 'text-white');
                element.classList.add('bg-gray-200', 'text-gray-800');
            } else if (selectedWords.length < 4) {
                // Select the word
                selectedWords.push(word);
                element.classList.add('tile-selected');
                element.classList.remove('bg-gray-200', 'text-gray-800');
            }

            // Enable/disable submit button
            SUBMIT_BUTTON.disabled = selectedWords.length !== 4;
            MESSAGE_DISPLAY.textContent = selectedWords.length < 4 ? `Need ${4 - selectedWords.length} more words!` : "Ready to Guess!";
        }

        // --- Deselect All Tiles ---
        function deselectAll() {
            selectedWords = [];
            document.querySelectorAll('.tile').forEach(tile => {
                if (!solvedGroups.some(g => g.words.includes(tile.getAttribute('data-word')))) {
                    tile.classList.remove('tile-selected');
                    tile.classList.remove('bg-indigo-600', 'text-white');
                    tile.classList.add('bg-gray-200', 'text-gray-800');
                }
            });
            SUBMIT_BUTTON.disabled = true;
            MESSAGE_DISPLAY.textContent = "Click 4 words that match!";
        }

        // --- Submit Guess Logic ---
        function submitGuess() {
            if (isGameOver || selectedWords.length !== 4) return;

            // Sort the selected words for easy comparison
            const sortedSelected = [...selectedWords].sort().join(',');

            let isCorrect = false;
            let correctGroup = null;

            // Check if the selected words match any unsolved group
            for (const group of currentPuzzle) {
                if (!solvedGroups.includes(group)) {
                    const sortedGroup = [...group.words].sort().join(',');
                    if (sortedSelected === sortedGroup) {
                        isCorrect = true;
                        correctGroup = group;
                        break;
                    }
                }
            }

            if (isCorrect) {
                handleCorrectGuess(correctGroup);
            } else {
                handleIncorrectGuess();
            }

            // Check for game end after every guess
            checkGameEnd();
        }

        // --- Handle Correct Guess ---
        function handleCorrectGuess(group) {
            solvedGroups.push(group);
            MESSAGE_DISPLAY.textContent = `⭐ Solved: ${group.name}! Great job!`;
            MESSAGE_DISPLAY.classList.add('text-green-600');
            MESSAGE_DISPLAY.classList.remove('text-indigo-600', 'text-red-500');

            // Find and style the solved tiles
            document.querySelectorAll('.tile').forEach(tile => {
                const word = tile.getAttribute('data-word');
                if (group.words.includes(word)) {
                    tile.classList.remove('tile-selected', 'bg-gray-200', 'text-gray-800', 'bg-indigo-600', 'text-white');
                    tile.classList.add(group.groupClass, 'cursor-default');
                    tile.onclick = null; // Disable clicking on solved tiles
                }
            });

            // Remove solved words from the words list and re-render/re-order the remaining tiles
            allWords = allWords.filter(word => !group.words.includes(word));
            selectedWords = []; // Clear selection
            SUBMIT_BUTTON.disabled = true;

            // Re-render the grid (Solved tiles stay, remaining tiles are redrawn/shuffled)
            reorderGrid();
        }

        // --- Handle Incorrect Guess ---
        function handleIncorrectGuess() {
            lives--;
            LIVES_DISPLAY.textContent = lives;
            MESSAGE_DISPLAY.textContent = "❌ Try again! That's not a group.";
            MESSAGE_DISPLAY.classList.add('text-red-500');
            MESSAGE_DISPLAY.classList.remove('text-green-600', 'text-indigo-600');

            // Apply shake animation to selected tiles
            document.querySelectorAll('.tile-selected').forEach(tile => {
                tile.classList.add('shake-animation');
                setTimeout(() => {
                    tile.classList.remove('shake-animation');
                }, 500);
            });

            // Optional: deselect all after a short delay for cleaner UI
            setTimeout(deselectAll, 1000);
        }

        // --- Reorder the Grid (Moves solved tiles to the top) ---
        function reorderGrid() {
            const solvedTiles = [];
            const remainingTiles = [];

            // 1. Collect solved tiles
            solvedGroups.forEach(group => {
                group.words.forEach(word => {
                    const tile = document.querySelector(`.tile[data-word="${word}"]`);
                    if (tile) solvedTiles.push(tile);
                });
            });

            // 2. Collect remaining tiles (words in allWords)
            allWords.forEach(word => {
                const tile = document.querySelector(`.tile[data-word="${word}"]`);
                if (tile) remainingTiles.push(tile);
            });

            GRID.innerHTML = ''; // Clear grid
            // 3. Append solved tiles first
            solvedTiles.forEach(tile => GRID.appendChild(tile));
            // 4. Append remaining (shuffled) tiles
            remainingTiles.forEach(tile => GRID.appendChild(tile));

            // Ensure the grid structure is correctly filled (4 columns)
            GRID.style.gridTemplateRows = `repeat(${4}, minmax(0, 1fr))`;
        }

        // --- Check Game End ---
        function checkGameEnd() {
            if (solvedGroups.length === 4) {
                // WIN CONDITION
                isGameOver = true;
                const endTime = Date.now();
                // Calculate the total time in seconds and the number of mistakes made
                const durationSeconds = Math.floor((endTime - startTime) / 1000);
                const mistakesMade = 4 - lives;

                // Call showModal with the win data (title, duration, mistakes)
                showModal("🎉 You Won!", durationSeconds, mistakesMade);
            } else if (lives <= 0) {
                // LOSE CONDITION
                isGameOver = true;
                // Reveal the answers
                const remainingGroup = currentPuzzle.find(group => !solvedGroups.includes(group));
                let message = "Oops, you ran out of tries! The last group was: ";
                if (remainingGroup) {
                     // Display the remaining category name and words
                     message += `<div class="mt-4 p-3 rounded-xl text-center shadow-md ${remainingGroup.groupClass}">
                                    <div class="text-sm font-semibold">${remainingGroup.name.toUpperCase()}</div>
                                    <div class="text-xs font-medium opacity-80">${remainingGroup.words.join(', ')}</div>
                                 </div>`;
                } else {
                     message += "Something went wrong (No remaining group found).";
                }
                // Call showModal with the lose message (title, message string, null for stats)
                showModal("Game Over!", message, null);
            }
        }

        // --- Show Modal ---
        // Modified to handle win stats (durationSeconds, mistakesMade)
        function showModal(title, messageOrDuration, mistakesMade) {
            MODAL_TITLE.innerHTML = title;
            MODAL_MESSAGE.innerHTML = ''; // Clear existing content

            if (title.includes("Won") && mistakesMade !== null) {
                // WINNING SCREEN LOGIC
                const durationSeconds = messageOrDuration; // duration in seconds
                const mistakes = mistakesMade;

                // 1. Display Stats
                const statsHtml = `
                    <div class="mb-6 flex justify-around items-center text-center">
                        <div class="p-3 bg-red-100 rounded-lg shadow-md w-1/2 mx-1">
                            <div class="text-2xl font-extrabold text-red-700">${mistakes}</div>
                            <div class="text-xs text-gray-500 font-semibold">Mistakes</div>
                        </div>
                        <div class="p-3 bg-indigo-100 rounded-lg shadow-md w-1/2 mx-1">
                            <div class="text-2xl font-extrabold text-indigo-700">${formatTime(durationSeconds)}</div>
                            <div class="text-xs text-gray-500 font-semibold">Time Taken</div>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2">Your Solved Groups:</h3>
                `;
                MODAL_MESSAGE.insertAdjacentHTML('beforeend', statsHtml);


                // 2. Display Solved Groups
                solvedGroups.forEach(group => {
                    const groupHtml = `
                        <div class="p-3 mb-2 rounded-xl text-center shadow-md ${group.groupClass}">
                            <div class="text-sm font-semibold">${group.name.toUpperCase()}</div>
                            <div class="text-xs font-medium opacity-80">${group.words.join(', ')}</div>
                        </div>
                    `;
                    MODAL_MESSAGE.insertAdjacentHTML('beforeend', groupHtml);
                });


            } else {
                // LOSING SCREEN LOGIC (messageOrDuration is the message string)
                MODAL_MESSAGE.innerHTML = `<p class="text-lg text-gray-600 mb-6">${messageOrDuration}</p>`;
            }


            MODAL.classList.remove('hidden');
            // Animate in the modal content
            setTimeout(() => MODAL_CONTENT.classList.add('scale-100'), 10);
        }
        
        // --- New function to close the modal and return to the main menu ---
        function closeModalAndGoHome() {
            MODAL.classList.add('hidden');
            MODAL_CONTENT.classList.remove('scale-100');
            showView('home-screen'); // Go back to the menu
        }

        // Initialize the app to show the home screen
        window.onload = function() {
            showView('home-screen');
        };

    </script>
</body>
</html>
